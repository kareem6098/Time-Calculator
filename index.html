<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Supervisor Tools</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0V4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- html2canvas CDN for screenshots -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJLWx6P+3cGbNfvFgHvFbmE6PmCDwlmQ+eHgZndE7From1JoxVXWbVGVxIIMtfVAobEVigXQAbjYjefQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* Custom styles for the Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Hide number input arrows */
        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Custom class for selected button state */
        .option-button.selected, .shift-button.selected, .location-button.selected { /* Added .location-button.selected */
            background-color: #10B981; /* Tailwind green-500 */
            color: white;
            border-color: #059669; /* Tailwind green-600 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Styling for the info message box */
        .info-message-box, .confirm-message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #e0f2fe; /* Light blue */
            border: 1px solid #90cdf4; /* Medium blue */
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            text-align: center;
            max-width: 80%;
        }
        .info-message-box button, .confirm-message-box button {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background-color: #2563eb; /* Blue-700 */
            color: white;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
        }
        .confirm-message-box .button-group {
            display: flex;
            justify-content: center;
            gap: 1rem; /* Space between buttons */
            margin-top: 1rem;
        }
        .confirm-message-box .button-group button {
            flex: 1; /* Make buttons take equal width */
            margin-top: 0; /* Override default button margin */
        }
        /* Navigation button styling */
        .nav-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            /* Adjusted for better responsiveness */
            flex-grow: 1; /* Allow to grow */
            flex-shrink: 1; /* Allow to shrink */
            min-width: 80px; /* Minimum width to prevent squishing too much */
            text-align: center;
        }
        .nav-button.active {
            background-color: #4CAF50; /* A shade of green */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .nav-button:not(.active) {
            background-color: #e0e0e0; /* Light gray */
            color: #424242; /* Dark gray text */
            border: 1px solid #c0c0c0;
        }
        .nav-button:not(.active):hover {
            background-color: #d0d0d0;
        }
        /* Small delete button in table */
        .delete-record-btn {
            background-color: #ef4444; /* Red-500 */
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem; /* Rounded-md */
            font-size: 0.75rem; /* Text-xs */
            font-weight: bold;
            transition: background-color 0.2s;
            cursor: pointer;
            display: flex; /* Use flex to center icon */
            justify-content: center;
            align-items: center;
            width: 2.5rem; /* Fixed width for consistent button size */
            height: 2.5rem; /* Fixed height for consistent button size */
        }
        .delete-record-btn:hover {
            background-color: #dc2626; /* Red-600 */
        }
        .delete-record-btn i {
            font-size: 1rem; /* Adjust icon size */
        }
        /* Adjusted font size for location buttons to ensure text fits */
        .location-button {
            font-size: 0.875rem; /* text-sm */
            padding: 0.75rem 0.75rem; /* Reduced horizontal padding slightly */
        }
        /* Responsive adjustment for location buttons on larger screens if needed */
        @media (min-width: 640px) { /* Tailwind's sm breakpoint */
            .location-button {
                font-size: 1rem; /* text-base on larger screens */
                padding: 0.75rem 1.5rem; /* Restore original padding */
            }
        }
    </style>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Apple Touch Icon (for iOS home screen) -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#bbf7d0"> <!-- Matches a light green/teal -->

</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-200 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-200">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-6">Production Supervisor Tools</h1>

        <!-- Navigation Buttons -->
        <div class="flex flex-wrap justify-center gap-2 mb-6"> <!-- Changed space-x-4 to gap-2 and added flex-wrap -->
            <button id="navTimeCalc" class="nav-button active">CIP Time</button>
            <button id="navAgencyRecord" class="nav-button">Agency Record</button>
            <button id="navChemicalInventory" class="nav-button">Chemical Inventory</button>
            <button id="navHeatStressMonitor" class="nav-button">Heat Stress</button>
        </div>

        <!-- CIP Time Section -->
        <div id="timeCalculationSection" class="space-y-6">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">CIP Time</h2>
            <!-- Current Time Display -->
            <div class="bg-green-50 p-4 rounded-xl border border-green-100 shadow-sm text-center">
                <label class="block text-lg font-semibold text-green-700 mb-2">Current Time:</label>
                <p id="currentTimeDisplay" class="text-3xl font-bold text-green-800"></p>
            </div>

            <!-- Option Buttons -->
            <div class="flex justify-center space-x-2 mb-4">
                <button class="option-button p-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-700 font-semibold text-lg flex-1 hover:bg-gray-200 transition-colors duration-200" data-option="A">A</button>
                <button class="option-button p-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-700 font-semibold text-lg flex-1 hover:bg-gray-200 transition-colors duration-200" data-option="B">B</button>
                <button class="option-button p-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-700 font-semibold text-lg flex-1 hover:bg-gray-200 transition-colors duration-200" data-option="C">C</button>
                <button class="option-button p-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-700 font-semibold text-lg flex-1 hover:bg-gray-200 transition-colors duration-200" data-option="D">D</button>
            </div>

            <!-- Hours and Minutes to Subtract from 45:00 Inputs -->
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 shadow-sm">
                <label class="block text-lg font-semibold text-blue-700 mb-3">Subtract from 45 hours</label>
                <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-3">
                    <input type="number" id="hoursToSubtract" placeholder="Hours" min="0"
                           class="w-full sm:w-1/2 p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent text-center text-lg font-medium text-gray-700 bg-white shadow-sm">
                    <span class="text-2xl text-blue-500">h</span>
                    <input type="number" id="minutesToSubtract" placeholder="MM" min="0" max="59"
                           class="w-full sm:w-1/2 p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent text-center text-lg font-medium text-gray-700 bg-white shadow-sm">
                    <span class="text-2xl text-blue-500">m</span>
                </div>
            </div>

            <!-- Calculate Button -->
            <button id="calculateBtn"
                    class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white py-3 rounded-xl text-xl font-bold hover:from-green-600 hover:to-teal-700 transition-all duration-300 shadow-lg transform hover:scale-105 active:scale-95">
                Calculate Resulting Time
            </button>

            <!-- Error Message for input validation -->
            <div id="inputErrorBox" class="bg-red-100 p-3 rounded-xl border border-red-200 text-red-700 text-center font-medium hidden">
                Please enter valid numbers for hours and minutes.
            </div>

            <!-- Error Message for duplicate option -->
            <div id="duplicateErrorBox" class="bg-red-100 p-3 rounded-xl border border-red-200 text-red-700 text-center font-medium hidden">
                This option has already been calculated. Please click "Reset History" to calculate it again.
            </div>

            <!-- Calculation History -->
            <div id="historyContainer" class="bg-gray-100 p-5 rounded-xl border border-gray-200 shadow-inner">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Calculation History</h2>
                <div class="overflow-x-auto">
                    <table id="calculationHistoryTable" class="min-w-full bg-white rounded-lg shadow-sm border border-gray-200">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-2 text-left">Line</th>
                                <th class="py-3 px-2 text-left">Day</th>
                                <th class="py-3 px-2 text-left">Time</th>
                            </tr>
                        </thead>
                        <tbody id="calculationHistoryList" class="text-gray-600 text-sm font-light">
                            <!-- Records will be dynamically inserted here by JavaScript -->
                            <tr id="noHistoryMessageRow" class="hidden">
                                <td colspan="3" class="py-3 px-2 text-center text-gray-500">No calculations yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <button id="resetHistoryBtn"
                        class="w-full mt-2 bg-red-500 text-white py-2 rounded-xl text-lg font-bold hover:bg-red-600 transition-colors duration-300 shadow-md">
                    Reset History
                </button>

                <button id="takeTimeCalcScreenshotBtn"
                        class="w-full mt-2 bg-blue-500 text-white py-2 rounded-xl text-lg font-bold hover:bg-blue-600 transition-colors duration-300 shadow-md">
                    Take Screenshot
                </button>
            </div>
        </div>

        <!-- Agency Record Section (Initially Hidden) -->
        <div id="agencyRecordSection" class="space-y-6 hidden">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Agency Record</h2>

            <div class="bg-purple-50 p-4 rounded-xl border border-purple-100 shadow-sm space-y-4">
                <div class="flex flex-col">
                    <label for="agencyName" class="block text-lg font-semibold text-purple-700 mb-2">Name:</label>
                    <input type="text" id="agencyName" placeholder="Enter name"
                           class="p-3 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent text-lg font-medium text-gray-700 bg-white shadow-sm">
                </div>

                <div class="flex flex-col">
                    <label class="block text-lg font-semibold text-purple-700 mb-2">Time:</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="agencyTimeHour" placeholder="HH" min="1" max="12" value="12"
                               class="w-1/3 p-3 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent text-center text-lg font-medium text-gray-700 bg-white shadow-sm">
                        <span class="text-2xl text-purple-500">:</span>
                        <input type="number" id="agencyTimeMinute" placeholder="MM" min="0" max="59" value="00"
                               class="w-1/3 p-3 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent text-center text-lg font-medium text-gray-700 bg-white shadow-sm">
                        <select id="agencyTimeAmPm"
                                class="w-1/3 p-3 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent text-center text-lg font-medium text-gray-700 bg-white shadow-sm">
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                        </select>
                    </div>
                </div>

                <button id="saveAgencyRecordBtn"
                        class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 rounded-xl text-xl font-bold hover:from-purple-600 hover:to-indigo-700 transition-all duration-300 shadow-lg transform hover:scale-105 active:scale-95">
                    Save Entry
                </button>

                <!-- Error Message for Agency Record inputs -->
                <div id="agencyRecordErrorBox" class="bg-red-100 p-3 rounded-xl border border-red-200 text-red-700 text-center font-medium hidden">
                    Please fill in all fields for Agency Record.
                </div>
            </div>

            <!-- Agency Record History -->
            <div id="agencyRecordHistoryContainer" class="bg-gray-100 p-5 rounded-xl border border-gray-200 shadow-inner">
                <h3 class="text-xl font-bold text-gray-800 mb-3 text-center">Saved Records</h3>
                <!-- Replaced div with table structure -->
                <div class="overflow-x-auto">
                    <table id="agencyRecordTable" class="min-w-full bg-white rounded-lg shadow-sm border border-gray-200">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-2 text-left">Name</th>
                                <th class="py-3 px-2 text-left">Day</th>
                                <th class="py-3 px-2 text-left">Time</th>
                                <th class="py-3 px-2 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agencyRecordList" class="text-gray-600 text-sm font-light">
                            <!-- Records will be dynamically inserted here by JavaScript -->
                            <tr id="noAgencyRecordsMessageRowAgency" class="hidden">
                                <td colspan="4" class="py-3 px-2 text-center text-gray-500">No records yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <button id="exportAgencyRecordsCsvBtn"
                        class="w-full mt-4 bg-green-600 text-white py-2 rounded-xl text-lg font-bold hover:bg-green-700 transition-colors duration-300 shadow-md">
                    Export to CSV
                </button>

                <button id="takeAgencyScreenshotBtn"
                        class="w-full mt-2 bg-blue-500 text-white py-2 rounded-xl text-lg font-bold hover:bg-blue-600 transition-colors duration-300 shadow-md">
                    Take Screenshot
                </button>

                <button id="undoDeleteRecordBtn"
                        class="w-full mt-2 bg-yellow-500 text-white py-2 rounded-xl text-lg font-bold hover:bg-yellow-600 transition-colors duration-300 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                    Undo Last Action
                </button>

                <button id="resetAgencyRecordsBtn"
                        class="w-full mt-2 bg-red-500 text-white py-2 rounded-xl text-lg font-bold hover:bg-red-600 transition-colors duration-300 shadow-md">
                    Reset All Agency Records
                </button>
            </div>
        </div>

        <!-- Chemical Inventory Section (Initially Hidden) -->
        <div id="chemicalInventorySection" class="space-y-6 hidden">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Chemical Inventory</h2>

            <div class="bg-teal-50 p-4 rounded-xl border border-teal-100 shadow-sm space-y-4">
                <div class="flex flex-col">
                    <label for="chemicalNameSelect" class="block text-lg font-semibold text-teal-700 mb-2">Chemical Name:</label>
                    <select id="chemicalNameSelect"
                            class="p-3 border border-teal-300 rounded-lg focus:ring-2 focus:ring-teal-400 focus:border-transparent text-lg font-medium text-gray-700 bg-white shadow-sm">
                        <option value="">Select Chemical</option>
                        <option value="Peroxide">Peroxide</option>
                        <option value="Envirocid (acid)">Envirocid (acid)</option>
                        <option value="Soil Off">Soil Off</option>
                        <option value="Oxonia">Oxonia</option>
                        <option value="Sterbac">Sterbac</option>
                        <option value="MIP (alkaline)">MIP (alkaline)</option>
                    </select>
                </div>

                <div class="flex flex-col">
                    <label for="chemicalQuantity" class="block text-lg font-semibold text-teal-700 mb-2">Quantity:</label>
                    <input type="number" id="chemicalQuantity" placeholder="e.g., 50 (liters/kg)" min="0"
                           class="p-3 border border-teal-300 rounded-lg focus:ring-2 focus:ring-teal-400 focus:border-transparent text-lg font-medium text-gray-700 bg-white shadow-sm">
                </div>

                <div class="flex flex-col">
                    <label class="block text-lg font-semibold text-teal-700 mb-2">Shift:</label>
                    <div class="flex justify-center space-x-2">
                        <button class="shift-button p-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-700 font-semibold text-lg flex-1 hover:bg-gray-200 transition-colors duration-200" data-shift="D1">D1</button>
                        <button class="shift-button p-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-700 font-semibold text-lg flex-1 hover:bg-gray-200 transition-colors duration-200" data-shift="N2">N2</button>
                        <button class="shift-button p-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-700 font-semibold text-lg flex-1 hover:bg-gray-200 transition-colors duration-200" data-shift="D3">D3</button>
                        <button class="shift-button p-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-700 font-semibold text-lg flex-1 hover:bg-gray-200 transition-colors duration-200" data-shift="N4">N4</button>
                    </div>
                </div>

                <button id="addChemicalBtn"
                        class="w-full bg-gradient-to-r from-teal-500 to-cyan-600 text-white py-3 rounded-xl text-xl font-bold hover:from-teal-600 hover:to-cyan-700 transition-all duration-300 shadow-lg transform hover:scale-105 active:scale-95">
                    Add Chemical
                </button>

                <!-- Error Message for Chemical Inventory inputs -->
                <div id="chemicalInventoryErrorBox" class="bg-red-100 p-3 rounded-xl border border-red-200 text-red-700 text-center font-medium hidden">
                    Please select chemical, shift, and enter a valid quantity.
                </div>
            </div>

            <!-- Chemical Inventory History -->
            <div id="chemicalInventoryHistoryContainer" class="bg-gray-100 p-5 rounded-xl border border-gray-200 shadow-inner">
                <h3 class="text-xl font-bold text-gray-800 mb-3 text-center">Current Inventory</h3>
                <div class="overflow-x-auto">
                    <table id="chemicalInventoryTable" class="min-w-full bg-white rounded-lg shadow-sm border border-gray-200">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-2 text-left">Date</th>
                                <th class="py-3 px-2 text-left">Shift</th>
                                <th class="py-3 px-2 text-left">Chemical</th>
                                <th class="py-3 px-2 text-left">Quantity</th>
                                <th class="py-3 px-2 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="chemicalInventoryList" class="text-gray-600 text-sm font-light">
                            <!-- Chemical entries will be dynamically inserted here by JavaScript -->
                            <tr id="noChemicalsMessageRow" class="hidden">
                                <td colspan="5" class="py-3 px-2 text-center text-gray-500">No chemicals in inventory.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <button id="exportChemicalsCsvBtn"
                        class="w-full mt-4 bg-green-600 text-white py-2 rounded-xl text-lg font-bold hover:bg-green-700 transition-colors duration-300 shadow-md">
                    Export to CSV
                </button>

                <button id="takeChemicalScreenshotBtn"
                        class="w-full mt-2 bg-blue-500 text-white py-2 rounded-xl text-lg font-bold hover:bg-blue-600 transition-colors duration-300 shadow-md">
                    Take Screenshot
                </button>

                <button id="resetChemicalInventoryBtn"
                        class="w-full mt-2 bg-red-500 text-white py-2 rounded-xl text-lg font-bold hover:bg-red-600 transition-colors duration-300 shadow-md">
                    Reset All Chemicals
                </button>
            </div>
        </div>

        <!-- New: Heat Stress Monitor Section -->
        <div id="heatStressMonitorSection" class="space-y-6 hidden">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Heat Stress Monitor</h2>

            <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 shadow-sm space-y-4">
                <div class="flex flex-col">
                    <label class="block text-lg font-semibold text-orange-700 mb-2">Location:</label>
                    <div class="grid grid-cols-3 gap-2 sm:grid-cols-3"> <!-- Changed grid-cols-4 to grid-cols-3 -->
                        <button class="location-button p-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition-colors duration-200" data-location="Filler">Filler</button>
                        <button class="location-button p-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition-colors duration-200" data-location="DE">DE</button>
                        <button class="location-button p-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition-colors duration-200" data-location="Process">Process</button>
                        <!-- Removed Maintenance button -->
                    </div>
                </div>

                <!-- New Input Fields for Temperature, RH%, WBGT -->
                <div class="flex flex-col">
                    <label for="heatStressTemperature" class="block text-lg font-semibold text-orange-700 mb-2">Temperature (째C):</label>
                    <input type="number" id="heatStressTemperature" placeholder="e.g., 25.0" step="0.1" inputmode="decimal" pattern="[0-9]*"
                           class="p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-transparent text-lg font-medium text-gray-700 bg-white shadow-sm">
                </div>

                <div class="flex flex-col">
                    <label for="heatStressRH" class="block text-lg font-semibold text-orange-700 mb-2">RH (%):</label>
                    <input type="number" id="heatStressRH" placeholder="e.g., 60" min="0" max="100" inputmode="decimal" pattern="[0-9]*"
                           class="p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-transparent text-lg font-medium text-gray-700 bg-white shadow-sm">
                </div>

                <div class="flex flex-col">
                    <label for="heatStressWBGT" class="block text-lg font-semibold text-orange-700 mb-2">WBGT (째C):</label>
                    <input type="number" id="heatStressWBGT" placeholder="e.g., 28.5" step="0.1" inputmode="decimal" pattern="[0-9]*"
                           class="p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-transparent text-lg font-medium text-gray-700 bg-white shadow-sm">
                </div>

                <button id="recordHeatStressBtn"
                        class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white py-3 rounded-xl text-xl font-bold hover:from-orange-600 hover:to-red-700 transition-all duration-300 shadow-lg transform hover:scale-105 active:scale-95">
                    Record Reading
                </button>

                <!-- Error Message for Heat Stress Monitor inputs -->
                <div id="heatStressErrorBox" class="bg-red-100 p-3 rounded-xl border border-red-200 text-red-700 text-center font-medium hidden">
                    Please select a location and enter valid numbers for Temperature, RH% (0-100), and WBGT.
                </div>
            </div>

            <!-- Heat Stress Readings History -->
            <div id="heatStressHistoryContainer" class="bg-gray-100 p-5 rounded-xl border border-gray-200 shadow-inner">
                <h3 class="text-xl font-bold text-gray-800 mb-3 text-center">Recorded Readings</h3>
                <div class="overflow-x-auto">
                    <table id="heatStressTable" class="min-w-full bg-white rounded-lg shadow-sm border border-gray-200">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-2 text-left">Time</th>
                                <th class="py-3 px-2 text-left">Location</th>
                                <th class="py-3 px-2 text-left">Temp (째C)</th>
                                <th class="py-3 px-2 text-left">RH (%)</th>
                                <th class="py-3 px-2 text-left">WBGT (째C)</th>
                                <!-- Removed Actions column header -->
                            </tr>
                        </thead>
                        <tbody id="heatStressList" class="text-gray-600 text-sm font-light">
                            <!-- Heat stress entries will be dynamically inserted here by JavaScript -->
                            <tr id="noHeatStressMessageRow" class="hidden">
                                <td colspan="5" class="py-3 px-2 text-center text-gray-500">No readings yet.</td> <!-- Updated colspan -->
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <button id="exportHeatStressCsvBtn"
                        class="w-full mt-4 bg-green-600 text-white py-2 rounded-xl text-lg font-bold hover:bg-green-700 transition-colors duration-300 shadow-md">
                    Export to CSV
                </button>

                <button id="takeHeatStressScreenshotBtn"
                        class="w-full mt-2 bg-blue-500 text-white py-2 rounded-xl text-lg font-bold hover:bg-blue-600 transition-colors duration-300 shadow-md">
                    Take Screenshot
                </button>

                <button id="resetHeatStressBtn"
                        class="w-full mt-2 bg-red-500 text-white py-2 rounded-xl text-lg font-bold hover:bg-red-600 transition-colors duration-300 shadow-md">
                    Reset All Readings
                </button>
            </div>
        </div>


    </div>

    <!-- Confirmation Message Box (hidden by default) -->
    <div id="confirmMessageBox" class="confirm-message-box hidden">
        <p id="confirmMessageText" class="text-gray-800 font-semibold"></p>
        <div class="button-group">
            <button id="confirmYesBtn" class="bg-red-600 hover:bg-red-700">Yes</button>
            <button id="confirmNoBtn" class="bg-gray-500 hover:bg-gray-600">No</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get references to main sections and navigation buttons
            const timeCalculationSection = document.getElementById('timeCalculationSection');
            const agencyRecordSection = document.getElementById('agencyRecordSection');
            const chemicalInventorySection = document.getElementById('chemicalInventorySection');
            const heatStressMonitorSection = document.getElementById('heatStressMonitorSection');
            const navTimeCalcBtn = document.getElementById('navTimeCalc');
            const navAgencyRecordBtn = document.getElementById('navAgencyRecord');
            const navChemicalInventoryBtn = document.getElementById('navChemicalInventory');
            const navHeatStressMonitorBtn = document.getElementById('navHeatStressMonitor');

            // Get references to calculator-specific elements
            const hoursToSubtractInput = document.getElementById('hoursToSubtract');
            const minutesToSubtractInput = document.getElementById('minutesToSubtract');
            const optionButtons = document.querySelectorAll('.option-button');
            const calculateBtn = document.getElementById('calculateBtn');
            const inputErrorBox = document.getElementById('inputErrorBox');
            const duplicateErrorBox = document.getElementById('duplicateErrorBox');
            const calculationHistoryTable = document.getElementById('calculationHistoryTable');
            const calculationHistoryList = document.getElementById('calculationHistoryList');
            const noHistoryMessageRow = document.getElementById('noHistoryMessageRow');
            const resetHistoryBtn = document.getElementById('resetHistoryBtn');
            const takeTimeCalcScreenshotBtn = document.getElementById('takeTimeCalcScreenshotBtn');

            // Global variables to store state
            let selectedOption = null;
            let calculatedOptions = new Set(); // To track which options have been calculated

            // Function to update current time display
            function updateCurrentTime() {
                const now = new Date();
                let hours = now.getHours();
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // The hour '0' should be '12'
                const formattedHours = String(hours).padStart(2, '0');
                document.getElementById('currentTimeDisplay').textContent = `${formattedHours}:${minutes} ${ampm}`;
            }

            // Update current time every second
            setInterval(updateCurrentTime, 1000);
            updateCurrentTime(); // Initial call to display time immediately

            // --- CIP Time Calculation Logic ---

            // Event listeners for option buttons
            optionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove 'selected' class from all option buttons
                    optionButtons.forEach(btn => btn.classList.remove('selected'));
                    // Add 'selected' class to the clicked button
                    button.classList.add('selected');
                    selectedOption = button.dataset.option;
                    hideError(duplicateErrorBox); // Hide duplicate error if an option is selected
                });
            });

            // Function to show an error message
            function showError(element, message) {
                element.textContent = message;
                element.classList.remove('hidden');
            }

            // Function to hide an error message
            function hideError(element) {
                element.classList.add('hidden');
            }

            // Main calculation function
            calculateBtn.addEventListener('click', () => {
                const hoursToSubtract = parseInt(hoursToSubtractInput.value);
                const minutesToSubtract = parseInt(minutesToSubtractInput.value);

                // Input validation
                if (isNaN(hoursToSubtract) || isNaN(minutesToSubtract) || hoursToSubtract < 0 || minutesToSubtract < 0 || minutesToSubtract > 59) {
                    showError(inputErrorBox, "Please enter valid numbers for hours (>=0) and minutes (0-59).");
                    return;
                } else {
                    hideError(inputErrorBox);
                }

                if (!selectedOption) {
                    showError(inputErrorBox, "Please select an option (A, B, C, or D).");
                    return;
                }

                if (calculatedOptions.has(selectedOption)) {
                    showError(duplicateErrorBox, `Option ${selectedOption} has already been calculated. Please reset history to re-calculate.`);
                    return;
                }

                // --- CORE LOGIC FIX STARTS HERE ---
                const BASE_HOURS = 45;
                const totalBaseMinutes = BASE_HOURS * 60; // 45 hours in minutes

                const inputTotalMinutes = hoursToSubtract * 60 + minutesToSubtract;

                // Calculate the remaining time from 45 hours
                let remainingMinutesFrom45 = totalBaseMinutes - inputTotalMinutes;

                // Handle cases where subtraction results in negative time (e.g., input > 45 hours)
                if (remainingMinutesFrom45 < 0) {
                    showMessageBox("Warning: Input time exceeds 45 hours. Calculation might be unexpected.", "warning");
                    remainingMinutesFrom45 = 0; // Or handle as per specific business logic, e.g., show error, cap at 0, etc.
                }

                // Get current time
                const now = new Date();
                let currentTotalMinutes = now.getHours() * 60 + now.getMinutes();

                // Add the remaining time from 45 hours to the current time
                let finalTotalMinutes = currentTotalMinutes + remainingMinutesFrom45;

                // Calculate final hours and minutes, handling day rollover
                let finalHours = Math.floor(finalTotalMinutes / 60);
                let finalMinutes = finalTotalMinutes % 60;

                let finalDay = now.toLocaleDateString('en-US', { weekday: 'short' }); // Get current day (e.g., Mon, Tue)

                // If finalHours exceeds 24, it means it rolled over to the next day
                if (finalHours >= 24) {
                    finalHours %= 24; // Adjust hours for 24-hour format
                    // Increment day (this is a simplified approach, for full date handling, you'd adjust the Date object)
                    const nextDayDate = new Date(now);
                    nextDayDate.setDate(now.getDate() + 1);
                    finalDay = nextDayDate.toLocaleDateString('en-US', { weekday: 'short' });
                }

                // Format the resulting time in AM/PM format
                let displayHours = finalHours % 12;
                displayHours = displayHours ? displayHours : 12; // the hour '0' should be '12'
                const ampm = finalHours >= 12 ? 'PM' : 'AM';
                const formattedResultTime = `${String(displayHours).padStart(2, '0')}:${String(finalMinutes).padStart(2, '0')} ${ampm}`;

                // Add to history
                addCalculationToHistory(selectedOption, finalDay, formattedResultTime);
                calculatedOptions.add(selectedOption); // Mark option as calculated

                // Clear inputs after calculation
                hoursToSubtractInput.value = '';
                minutesToSubtractInput.value = '';
                optionButtons.forEach(btn => btn.classList.remove('selected'));
                selectedOption = null;
            });

            // Function to add calculation to history table
            function addCalculationToHistory(option, day, time) {
                const newRow = calculationHistoryList.insertRow();
                newRow.className = "hover:bg-gray-50"; // Add hover effect for table rows

                const optionCell = newRow.insertCell();
                optionCell.textContent = option;
                optionCell.className = "py-3 px-2 whitespace-nowrap font-medium text-gray-900";

                const dayCell = newRow.insertCell();
                dayCell.textContent = day;
                dayCell.className = "py-3 px-2 whitespace-nowrap";

                const timeCell = newRow.insertCell();
                timeCell.textContent = time;
                timeCell.className = "py-3 px-2 whitespace-nowrap";

                // Hide "No calculations yet" message if history is not empty
                if (noHistoryMessageRow && !noHistoryMessageRow.classList.contains('hidden')) {
                    noHistoryMessageRow.classList.add('hidden');
                }
            }

            // Reset History Button
            resetHistoryBtn.addEventListener('click', () => {
                showConfirm("Are you sure you want to reset all CIP Time history?", () => {
                    calculationHistoryList.innerHTML = '<tr id="noHistoryMessageRow" class="hidden"><td colspan="3" class="py-3 px-2 text-center text-gray-500">No calculations yet.</td></tr>';
                    calculatedOptions.clear(); // Clear the set of calculated options
                    noHistoryMessageRow.classList.remove('hidden'); // Show the "No calculations yet" message
                    hideError(duplicateErrorBox); // Hide duplicate error
                    hideError(inputErrorBox); // Hide input error
                    // Reset selected option and button styles
                    optionButtons.forEach(btn => btn.classList.remove('selected'));
                    selectedOption = null;
                    showMessageBox("CIP Time history has been reset.", "success");
                });
            });

            // Screenshot functionality for CIP Time
            takeTimeCalcScreenshotBtn.addEventListener('click', () => {
                html2canvas(timeCalculationSection, {
                    scale: 2, // Increase scale for better quality
                    useCORS: true // Enable CORS for images if any
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = 'CIP_Time_Screenshot.png';
                    link.href = imgData;
                    link.click();
                    showMessageBox("Screenshot saved!", "success");
                }).catch(error => {
                    console.error('Error taking screenshot:', error);
                    showMessageBox("Failed to take screenshot.", "error");
                });
            });

            // --- General Message Box Functions ---
            const infoMessageBox = document.createElement('div');
            infoMessageBox.id = 'infoMessageBox';
            infoMessageBox.className = 'info-message-box hidden';
            infoMessageBox.innerHTML = `<p id="infoMessageText"></p><button id="infoMessageCloseBtn">OK</button>`;
            document.body.appendChild(infoMessageBox);

            document.getElementById('infoMessageCloseBtn').addEventListener('click', () => {
                infoMessageBox.classList.add('hidden');
            });

            function showMessageBox(message, type = 'info') {
                const infoMessageText = document.getElementById('infoMessageText');
                infoMessageText.textContent = message;
                infoMessageBox.className = `info-message-box ${type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-blue-100 border-blue-400 text-blue-700'}`;
                infoMessageBox.classList.remove('hidden');
            }

            // --- Confirmation Message Box Functions ---
            const confirmMessageBox = document.getElementById('confirmMessageBox');
            const confirmMessageText = document.getElementById('confirmMessageText');
            const confirmYesBtn = document.getElementById('confirmYesBtn');
            const confirmNoBtn = document.getElementById('confirmNoBtn');
            let confirmCallback = null; // Stores the callback function for confirmation

            function showConfirm(message, callback) {
                confirmMessageText.textContent = message;
                confirmCallback = callback;
                confirmMessageBox.classList.remove('hidden');
            }

            confirmYesBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                confirmMessageBox.classList.add('hidden');
            });

            confirmNoBtn.addEventListener('click', () => {
                confirmMessageBox.classList.add('hidden');
                confirmCallback = null; // Clear the callback
            });

            // --- Navigation Logic ---
            const sections = {
                timeCalculationSection: timeCalculationSection,
                agencyRecordSection: agencyRecordSection,
                chemicalInventorySection: chemicalInventorySection,
                heatStressMonitorSection: heatStressMonitorSection
            };

            const navButtons = {
                navTimeCalc: navTimeCalcBtn,
                navAgencyRecord: navAgencyRecordBtn,
                navChemicalInventory: navChemicalInventoryBtn,
                navHeatStressMonitor: navHeatStressMonitorBtn
            };

            function showSection(sectionId) {
                // Hide all sections, ensuring the element exists before accessing classList
                for (const id in sections) {
                    const sectionElement = sections[id];
                    if (sectionElement) {
                        sectionElement.classList.add('hidden');
                    } else {
                        console.warn(`Section element with ID ${id} not found.`);
                    }
                }

                // Show the selected section, ensuring the element exists
                const selectedSectionElement = sections[sectionId];
                if (selectedSectionElement) {
                    selectedSectionElement.classList.remove('hidden');
                } else {
                    console.error(`Selected section element with ID ${sectionId} not found.`);
                    return; // Exit if the selected section doesn't exist
                }

                // Deactivate all navigation buttons, ensuring the element exists
                for (const id in navButtons) {
                    const navButtonElement = navButtons[id];
                    if (navButtonElement) {
                        navButtonElement.classList.remove('active');
                    } else {
                        console.warn(`Navigation button element with ID ${id} not found.`);
                    }
                }

                // Activate the selected navigation button, ensuring the element exists
                const targetNavButtonId = `nav${sectionId.replace('Section', '')}`;
                const targetNavButtonElement = navButtons[targetNavButtonId];
                if (targetNavButtonElement) {
                    targetNavButtonElement.classList.add('active');
                } else {
                    console.error(`Target navigation button element with ID ${targetNavButtonId} not found.`);
                }
            }

            navTimeCalcBtn.addEventListener('click', () => showSection('timeCalculationSection'));
            navAgencyRecordBtn.addEventListener('click', () => showSection('agencyRecordSection'));
            navChemicalInventoryBtn.addEventListener('click', () => showSection('chemicalInventorySection'));
            navHeatStressMonitorBtn.addEventListener('click', () => showSection('heatStressMonitorSection'));

            // Initial section display
            showSection('timeCalculationSection');

            // --- Agency Record Section Logic ---
            const agencyNameInput = document.getElementById('agencyName');
            const agencyTimeHourInput = document.getElementById('agencyTimeHour');
            const agencyTimeMinuteInput = document.getElementById('agencyTimeMinute');
            const agencyTimeAmPmSelect = document.getElementById('agencyTimeAmPm');
            const saveAgencyRecordBtn = document.getElementById('saveAgencyRecordBtn');
            const agencyRecordErrorBox = document.getElementById('agencyRecordErrorBox');
            const agencyRecordList = document.getElementById('agencyRecordList');
            const noAgencyRecordsMessageRowAgency = document.getElementById('noAgencyRecordsMessageRowAgency');
            const exportAgencyRecordsCsvBtn = document.getElementById('exportAgencyRecordsCsvBtn');
            const takeAgencyScreenshotBtn = document.getElementById('takeAgencyScreenshotBtn');
            const undoDeleteRecordBtn = document.getElementById('undoDeleteRecordBtn');
            const resetAgencyRecordsBtn = document.getElementById('resetAgencyRecordsBtn');

            let agencyRecords = [];
            let lastDeletedAgencyRecord = null; // To store the last deleted record for undo functionality

            // Load agency records from local storage on startup
            loadAgencyRecords();

            function saveAgencyRecords() {
                localStorage.setItem('agencyRecords', JSON.stringify(agencyRecords));
            }

            function loadAgencyRecords() {
                const storedRecords = localStorage.getItem('agencyRecords');
                if (storedRecords) {
                    agencyRecords = JSON.parse(storedRecords);
                    renderAgencyRecords();
                } else {
                    showNoAgencyRecordsMessage();
                }
            }

            function renderAgencyRecords() {
                agencyRecordList.innerHTML = ''; // Clear existing records
                if (agencyRecords.length === 0) {
                    showNoAgencyRecordsMessage();
                    return;
                }
                hideNoAgencyRecordsMessage();
                agencyRecords.forEach((record, index) => {
                    const newRow = agencyRecordList.insertRow();
                    newRow.className = "bg-white border-b border-gray-200 hover:bg-gray-50";
                    newRow.setAttribute('data-index', index); // Add data-index for easy reference

                    newRow.insertCell().textContent = record.name;
                    newRow.insertCell().textContent = record.date;
                    newRow.insertCell().textContent = record.time;

                    const actionsCell = newRow.insertCell();
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteBtn.className = 'delete-record-btn';
                    deleteBtn.title = 'Delete Record';
                    deleteBtn.addEventListener('click', () => deleteAgencyRecord(index));
                    actionsCell.appendChild(deleteBtn);
                });
            }

            function showNoAgencyRecordsMessage() {
                if (noAgencyRecordsMessageRowAgency) {
                    noAgencyRecordsMessageRowAgency.classList.remove('hidden');
                }
            }

            function hideNoAgencyRecordsMessage() {
                if (noAgencyRecordsMessageRowAgency) {
                    noAgencyRecordsMessageRowAgency.classList.add('hidden');
                }
            }

            saveAgencyRecordBtn.addEventListener('click', () => {
                const name = agencyNameInput.value.trim();
                const hour = parseInt(agencyTimeHourInput.value);
                const minute = parseInt(agencyTimeMinuteInput.value);
                const ampm = agencyTimeAmPmSelect.value;

                if (!name || isNaN(hour) || isNaN(minute) || hour < 1 || hour > 12 || minute < 0 || minute > 59) {
                    showError(agencyRecordErrorBox, "Please fill in all fields correctly.");
                    return;
                } else {
                    hideError(agencyRecordErrorBox);
                }

                const now = new Date();
                const date = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')} ${ampm}`;

                const newRecord = { name, date, time };
                agencyRecords.push(newRecord);
                saveAgencyRecords();
                renderAgencyRecords();

                // Clear form fields
                agencyNameInput.value = '';
                agencyTimeHourInput.value = '12';
                agencyTimeMinuteInput.value = '00';
                agencyTimeAmPmSelect.value = 'AM';

                showMessageBox("Agency record saved successfully!", "success");
            });

            function deleteAgencyRecord(index) {
                showConfirm("Are you sure you want to delete this record?", () => {
                    lastDeletedAgencyRecord = { record: agencyRecords[index], index: index }; // Store for undo
                    agencyRecords.splice(index, 1);
                    saveAgencyRecords();
                    renderAgencyRecords();
                    undoDeleteRecordBtn.disabled = false; // Enable undo button
                    showMessageBox("Record deleted.", "success");
                });
            }

            undoDeleteRecordBtn.addEventListener('click', () => {
                if (lastDeletedAgencyRecord) {
                    agencyRecords.splice(lastDeletedAgencyRecord.index, 0, lastDeletedAgencyRecord.record);
                    saveAgencyRecords();
                    renderAgencyRecords();
                    lastDeletedAgencyRecord = null; // Clear undo data
                    undoDeleteRecordBtn.disabled = true; // Disable undo button
                    showMessageBox("Last action undone.", "success");
                }
            });

            resetAgencyRecordsBtn.addEventListener('click', () => {
                showConfirm("Are you sure you want to delete ALL agency records? This cannot be undone.", () => {
                    agencyRecords = [];
                    saveAgencyRecords();
                    renderAgencyRecords();
                    lastDeletedAgencyRecord = null; // Clear undo data
                    undoDeleteRecordBtn.disabled = true; // Disable undo button
                    showMessageBox("All agency records have been reset.", "success");
                });
            });

            exportAgencyRecordsCsvBtn.addEventListener('click', () => {
                if (agencyRecords.length === 0) {
                    showMessageBox("No records to export.", "warning");
                    return;
                }
                const headers = ["Name", "Date", "Time"];
                const csvRows = [
                    headers.join(','),
                    ...agencyRecords.map(record => `${record.name},${record.date},${record.time}`)
                ];
                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'agency_records.csv';
                link.click();
                showMessageBox("Agency records exported to CSV!", "success");
            });

            takeAgencyScreenshotBtn.addEventListener('click', () => {
                html2canvas(agencyRecordSection, {
                    scale: 2,
                    useCORS: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = 'Agency_Record_Screenshot.png';
                    link.href = imgData;
                    link.click();
                    showMessageBox("Screenshot saved!", "success");
                }).catch(error => {
                    console.error('Error taking screenshot:', error);
                    showMessageBox("Failed to take screenshot.", "error");
                });
            });

            // --- Chemical Inventory Section Logic ---
            const chemicalNameSelect = document.getElementById('chemicalNameSelect');
            const chemicalQuantityInput = document.getElementById('chemicalQuantity');
            const shiftButtons = document.querySelectorAll('.shift-button');
            const addChemicalBtn = document.getElementById('addChemicalBtn');
            const chemicalInventoryErrorBox = document.getElementById('chemicalInventoryErrorBox');
            const chemicalInventoryList = document.getElementById('chemicalInventoryList');
            const noChemicalsMessageRow = document.getElementById('noChemicalsMessageRow');
            const exportChemicalsCsvBtn = document.getElementById('exportChemicalsCsvBtn');
            const takeChemicalScreenshotBtn = document.getElementById('takeChemicalScreenshotBtn');
            const resetChemicalInventoryBtn = document.getElementById('resetChemicalInventoryBtn');

            let chemicalInventory = [];
            let selectedShift = null;

            // Load chemical inventory from local storage on startup
            loadChemicalInventory();

            function saveChemicalInventory() {
                localStorage.setItem('chemicalInventory', JSON.stringify(chemicalInventory));
            }

            function loadChemicalInventory() {
                const storedInventory = localStorage.getItem('chemicalInventory');
                if (storedInventory) {
                    chemicalInventory = JSON.parse(storedInventory);
                    renderChemicalInventory();
                } else {
                    showNoChemicalsMessage();
                }
            }

            function renderChemicalInventory() {
                chemicalInventoryList.innerHTML = ''; // Clear existing entries
                if (chemicalInventory.length === 0) {
                    showNoChemicalsMessage();
                    return;
                }
                hideNoChemicalsMessage();
                chemicalInventory.forEach((item, index) => {
                    const newRow = chemicalInventoryList.insertRow();
                    newRow.className = "bg-white border-b border-gray-200 hover:bg-gray-50";

                    newRow.insertCell().textContent = item.date;
                    newRow.insertCell().textContent = item.shift;
                    newRow.insertCell().textContent = item.chemical;
                    newRow.insertCell().textContent = item.quantity;

                    const actionsCell = newRow.insertCell();
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteBtn.className = 'delete-record-btn';
                    deleteBtn.title = 'Delete Record';
                    deleteBtn.addEventListener('click', () => deleteChemicalEntry(index));
                    actionsCell.appendChild(deleteBtn);
                });
            }

            function showNoChemicalsMessage() {
                if (noChemicalsMessageRow) {
                    noChemicalsMessageRow.classList.remove('hidden');
                }
            }

            function hideNoChemicalsMessage() {
                if (noChemicalsMessageRow) {
                    noChemicalsMessageRow.classList.add('hidden');
                }
            }

            shiftButtons.forEach(button => {
                button.addEventListener('click', () => {
                    shiftButtons.forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    selectedShift = button.dataset.shift;
                });
            });

            addChemicalBtn.addEventListener('click', () => {
                const chemical = chemicalNameSelect.value;
                const quantity = parseFloat(chemicalQuantityInput.value);

                if (!chemical || !selectedShift || isNaN(quantity) || quantity <= 0) {
                    showError(chemicalInventoryErrorBox, "Please select chemical, shift, and enter a valid quantity.");
                    return;
                } else {
                    hideError(chemicalInventoryErrorBox);
                }

                const now = new Date();
                const date = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                const newEntry = { date, shift: selectedShift, chemical, quantity };
                chemicalInventory.push(newEntry);
                saveChemicalInventory();
                renderChemicalInventory();

                // Clear form fields
                chemicalNameSelect.value = '';
                chemicalQuantityInput.value = '';
                shiftButtons.forEach(btn => btn.classList.remove('selected'));
                selectedShift = null;

                showMessageBox("Chemical added to inventory!", "success");
            });

            function deleteChemicalEntry(index) {
                showConfirm("Are you sure you want to delete this chemical entry?", () => {
                    chemicalInventory.splice(index, 1);
                    saveChemicalInventory();
                    renderChemicalInventory();
                    showMessageBox("Chemical entry deleted.", "success");
                });
            }

            resetChemicalInventoryBtn.addEventListener('click', () => {
                showConfirm("Are you sure you want to reset ALL chemical inventory? This cannot be undone.", () => {
                    chemicalInventory = [];
                    saveChemicalInventory();
                    renderChemicalInventory();
                    showMessageBox("All chemical inventory has been reset.", "success");
                });
            });

            exportChemicalsCsvBtn.addEventListener('click', () => {
                if (chemicalInventory.length === 0) {
                    showMessageBox("No chemical records to export.", "warning");
                    return;
                }
                const headers = ["Date", "Shift", "Chemical", "Quantity"];
                const csvRows = [
                    headers.join(','),
                    ...chemicalInventory.map(item => `${item.date},${item.shift},${item.chemical},${item.quantity}`)
                ];
                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'chemical_inventory.csv';
                link.click();
                showMessageBox("Chemical inventory exported to CSV!", "success");
            });

            takeChemicalScreenshotBtn.addEventListener('click', () => {
                html2canvas(chemicalInventorySection, {
                    scale: 2,
                    useCORS: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = 'Chemical_Inventory_Screenshot.png';
                    link.href = imgData;
                    link.click();
                    showMessageBox("Screenshot saved!", "success");
                }).catch(error => {
                    console.error('Error taking screenshot:', error);
                    showMessageBox("Failed to take screenshot.", "error");
                });
            });

            // --- Heat Stress Monitor Section Logic ---
            const locationButtons = document.querySelectorAll('.location-button');
            const heatStressTemperatureInput = document.getElementById('heatStressTemperature');
            const heatStressRHInput = document.getElementById('heatStressRH');
            const heatStressWBGTInput = document.getElementById('heatStressWBGT');
            const recordHeatStressBtn = document.getElementById('recordHeatStressBtn');
            const heatStressErrorBox = document.getElementById('heatStressErrorBox');
            const heatStressList = document.getElementById('heatStressList');
            const noHeatStressMessageRow = document.getElementById('noHeatStressMessageRow');
            const exportHeatStressCsvBtn = document.getElementById('exportHeatStressCsvBtn');
            const takeHeatStressScreenshotBtn = document.getElementById('takeHeatStressScreenshotBtn');
            const resetHeatStressBtn = document.getElementById('resetHeatStressBtn');

            let heatStressReadings = [];
            let selectedLocation = null;

            // Load heat stress readings from local storage on startup
            loadHeatStressReadings();

            function saveHeatStressReadings() {
                localStorage.setItem('heatStressReadings', JSON.stringify(heatStressReadings));
            }

            function loadHeatStressReadings() {
                const storedReadings = localStorage.getItem('heatStressReadings');
                if (storedReadings) {
                    heatStressReadings = JSON.parse(storedReadings);
                    renderHeatStressReadings();
                } else {
                    showNoHeatStressMessage();
                }
            }

            function renderHeatStressReadings() {
                heatStressList.innerHTML = ''; // Clear existing entries
                if (heatStressReadings.length === 0) {
                    showNoHeatStressMessage();
                    return;
                }
                hideNoHeatStressMessage();
                heatStressReadings.forEach((reading) => {
                    const newRow = heatStressList.insertRow();
                    newRow.className = "bg-white border-b border-gray-200 hover:bg-gray-50";

                    newRow.insertCell().textContent = reading.time;
                    newRow.insertCell().textContent = reading.location;
                    newRow.insertCell().textContent = reading.temperature.toFixed(1); // Format to 1 decimal place
                    newRow.insertCell().textContent = reading.rh;
                    newRow.insertCell().textContent = reading.wbgt.toFixed(1); // Format to 1 decimal place
                });
            }

            function showNoHeatStressMessage() {
                if (noHeatStressMessageRow) {
                    noHeatStressMessageRow.classList.remove('hidden');
                }
            }

            function hideNoHeatStressMessage() {
                if (noHeatStressMessageRow) {
                    noHeatStressMessageRow.classList.add('hidden');
                }
            }

            locationButtons.forEach(button => {
                button.addEventListener('click', () => {
                    locationButtons.forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    selectedLocation = button.dataset.location;
                });
            });

            recordHeatStressBtn.addEventListener('click', () => {
                const temperature = parseFloat(heatStressTemperatureInput.value);
                const rh = parseInt(heatStressRHInput.value);
                const wbgt = parseFloat(heatStressWBGTInput.value);

                if (!selectedLocation || isNaN(temperature) || isNaN(rh) || isNaN(wbgt) || rh < 0 || rh > 100) {
                    showError(heatStressErrorBox, "Please select a location and enter valid numbers for Temperature, RH% (0-100), and WBGT.");
                    return;
                } else {
                    hideError(heatStressErrorBox);
                }

                const now = new Date();
                const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

                const newReading = { time, location: selectedLocation, temperature, rh, wbgt };
                heatStressReadings.push(newReading);
                saveHeatStressReadings();
                renderHeatStressReadings();

                // Clear form fields
                heatStressTemperatureInput.value = '';
                heatStressRHInput.value = '';
                heatStressWBGTInput.value = '';
                locationButtons.forEach(btn => btn.classList.remove('selected'));
                selectedLocation = null;

                showMessageBox("Heat stress reading recorded!", "success");
            });

            resetHeatStressBtn.addEventListener('click', () => {
                showConfirm("Are you sure you want to reset ALL heat stress readings? This cannot be undone.", () => {
                    heatStressReadings = [];
                    saveHeatStressReadings();
                    renderHeatStressReadings();
                    showMessageBox("All heat stress readings have been reset.", "success");
                });
            });

            exportHeatStressCsvBtn.addEventListener('click', () => {
                if (heatStressReadings.length === 0) {
                    showMessageBox("No heat stress readings to export.", "warning");
                    return;
                }
                const headers = ["Time", "Location", "Temperature (째C)", "RH (%)", "WBGT (째C)"];
                const csvRows = [
                    headers.join(','),
                    ...heatStressReadings.map(reading => `${reading.time},${reading.location},${reading.temperature.toFixed(1)},${reading.rh},${reading.wbgt.toFixed(1)}`)
                ];
                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'heat_stress_readings.csv';
                link.click();
                showMessageBox("Heat stress readings exported to CSV!", "success");
            });

            takeHeatStressScreenshotBtn.addEventListener('click', () => {
                html2canvas(heatStressMonitorSection, {
                    scale: 2,
                    useCORS: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = 'Heat_Stress_Screenshot.png';
                    link.href = imgData;
                    link.click();
                    showMessageBox("Screenshot saved!", "success");
                }).catch(error => {
                    console.error('Error taking screenshot:', error);
                    showMessageBox("Failed to take screenshot.", "error");
                });
            });
        });
    </script>
</body>
</html>
